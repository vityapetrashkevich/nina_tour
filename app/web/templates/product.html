{% extends "base.html" %}

{% block title %}
    {{ product.name if product else "Guide" }}
{% endblock %}

{% block content %}

{% if product %}

<!--    <div class="guide-label">{{ t.guide_label }}</div>-->

    <div class="title">
        {% if product.name_html %}
            {{ product.name_html | safe }}
        {% else %}
            {{ product.name }}
        {% endif %}
    </div>

    {% if product.price %}
    <div class="price-row">
        <span class="price-value">
            {{ (product.price / 100) | round(2) }} {{ product.currency }}
        </span>
    </div>
    {% endif %}

    <div class="intro">
        {{ product.description_html | safe }}
    </div>

    <h2 class="gallery-header">{{ t.inside_header }}</h2>
    <div class="image-text-wrapper">
    {% for image in product.images %}
    <div class="image-text-block {% if loop.index is even %}reverse{% endif %}">
        <div class="image-side">
            <img src="{{ image.url }}" alt="">
        </div>

        <div class="dot">
            <svg width="20" height="20" viewBox="0 0 20 20">
                <circle cx="10" cy="10" r="10" fill="#647652"></circle>
            </svg>
        </div>

        <div class="text-side">
            {% if image.title %}
                <h3 class="image-title">{{ image.title }}</h3>
            {% endif %}

            <div class="image-description">
                {{ image.description_html | safe }}
            </div>
        </div>
    </div>
    {% endfor %}
    </div>
{% endif %}

{# --- BUY BUTTON + MODAL --- #}

<div class="buy-fixed">
    <button class="buy-btn" onclick="openModal()">{{ t.buy }}</button>
</div>

<div class="modal" id="modal">
    <div class="modal-box">
        <h3>{{ t.order_details }}</h3>

        <input id="email" type="email" placeholder="{{ t.email_placeholder }}" required>

        <label for="currency">{{ t.currency_label }}:</label>
        <select id="currency">
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="PLN">PLN</option>
        </select>

        <button class="primary" onclick="pay()">{{ t.go_to_payment }}</button>
        <button class="secondary" onclick="closeModal()">{{ t.cancel }}</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let productCode = "{{ product.product_code if product else '' }}";
    let lang = "{{ lang or 'en' }}";

    function openModal(){
        document.getElementById("modal").style.display = "flex";
    }

    function closeModal(){
        document.getElementById("modal").style.display = "none";
    }

    async function pay(){
        const email = document.getElementById("email").value;
        const currency = document.getElementById("currency").value;

        if(!email){
            alert("Введите email");
            return;
        }

        try {
            const response = await fetch("/api/v1/order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    product_code: productCode,
                    lang: lang,
                    customers_email: email,
                    settlement_currency: currency
                })
            });

            const data = await response.json();

            if (data.url) {
                window.location.href = data.url;
            } else if (data.detail) {
                alert("Ошибка: " + data.detail);
            } else {
                alert("Ошибка платёжной системы.");
            }
        } catch (e) {
            alert("Ошибка соединения");
        }
    }
</script>
{% endblock %}
